pipeline{
    agent any
    stages{
        stage("Verify shell environment"){
            steps{
                script{
                    // Get the job name and build number
                    def jobName = env.JOB_NAME
                    def buildNumber = env.BUILD_NUMBER

                    //Print the job name and build number
                    echo "JOB Name: $jobName"
                    echo "Build Number: $buildNumber"

                    //Verify dotnet and docker installed
                    sh 'sudo docker --version'
                    sh 'sudo dotnet --info'
                }
            }
        }
        
        stage('Checkout GIT Repository'){
            steps{
                script{
                    //Clone the GIT repository's master branch
                    def gitRepoUrl = 'https://github.com/Neeraj-Sharma-902/jenkins-sample-project.git'

                    checkout scmGit(
                        branches: [[name: '*/master']], 
                        extensions: [cloneOption(depth: 1, noTags: false, reference: '', shallow: true), 
                                     cleanBeforeCheckout(deleteUntrackedNestedRepositories: true)], 
                                     userRemoteConfigs: [[url: gitRepoUrl]])
                }
            }
        }

        stage('Build Allplication'){
            steps{
                sh 'chmod u+x ./jenkins-plugin-model/ci/01-build.sh && ./jenkins-plugin-model/ci/01-build.sh'
            }
        }
        
        stage('Unit Tests'){
            steps{
                sh 'chmod u+x ./jenkins-plugin-model/ci/03-unit-test.sh && ./jenkins-plugin-model/ci/03-unit-test.sh'
                mstest testResultsFile:"**/*.trx"
            }
        }

        stage("Push Docker Image"){
            steps{
                script{
                    def jobName = env.JOB_NAME
                    def buildNumber = env.BUILD_NUMBER

                    withCredentials([usernamePassword(credentialsId: 'docker', passwordVariable: 'DOCKER_HUB_PASSWORD', usernameVariable: 'DOCKER_HUB_USER')]) {
                        sh "chmod u+x ./jenkins-plugin-model/ci/04-push.sh && ./jenkins-plugin-model/ci/04-push.sh $buildNumber"
                    }

                    echo "Build Completed - Job Name: $jobName  --  Build Number: $buildNumber"
                }
                
            }
        }
    }
}